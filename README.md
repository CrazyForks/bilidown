## 开发环境启动指南

- 创建终端（进入 `web` 目录）

    ```bash
    # 启动前端开发服务
    npm run dev
    ```

- 创建终端（进入 `app` 目录）

    ```bash
    # 启动后端 TS 自动编译
    npm run dev:ts

- 创建终端（进入 `app` 目录）

    ```bash
    # 更新 Electron Forge 配置文件
    tsc forge.config.ts

    # 启动项目
    npm run start
    ```

## 打包发布

```bash
cd app

# 更新 Electron Forge 配置文件
tsc forge.config.ts

# 生成可执行文件
npm run package

# 生成安装包
npm run make
```

## 源码说明

- `app`：Node.js 环境开发
- `web`：浏览器环境开发

## 功能规划

1. 输入待解析链接，分析链接类型，执行不同的解析逻辑。
2. 支持解析的链接类型：
    1. 单个视频：[https://www.bilibili.com/video/BV1LLDCYJEU3/](https://www.bilibili.com/video/BV1LLDCYJEU3/)
    2. 番剧和影视剧：[https://www.bilibili.com/bangumi/play/ss48831](https://www.bilibili.com/bangumi/play/ss48831)（支持 `(ss|ep)\d+`）
    3. 视频合集：[https://space.bilibili.com/282565107/lists/1427135](https://space.bilibili.com/282565107/lists/1427135) 或者 [https://space.bilibili.com/1176277996/channel/collectiondetail?sid=1427135](https://space.bilibili.com/1176277996/channel/collectiondetail?sid=1427135)（视频合集中任意一个视频的播放地址都能解析出整个列表）
    6. 分 P 列表：[https://www.bilibili.com/video/BV14XwyeAEuU/](https://www.bilibili.com/video/BV14XwyeAEuU/)（分 P 列表中的任意一个视频的播放地址都能解析出整个列表）
    4. 收藏夹：[https://space.bilibili.com/1176277996/favlist?fid=1234122612](https://space.bilibili.com/1176277996/favlist?fid=1234122612)（将被转换为 [https://www.bilibili.com/list/ml1234122612](https://www.bilibili.com/list/ml1234122612)）
    5. UP 主空间地址：[https://space.bilibili.com/1176277996](https://space.bilibili.com/1176277996)（将被转换为：[https://www.bilibili.com/list/1176277996](https://www.bilibili.com/list/1176277996)）
        - 核心接口：https://api.bilibili.com/x/v2/medialist/resource/list?type=1&biz_id=1176277996&ps=99&oid=114339998668072&with_current=false
        - `biz_id` 是 UP 主的 UID。
        - `ps` 最大值为 99，表示返回的列表长度。
        - `oid` 是上一页列表的末尾项的 `id` 属性值，可以留空表示开头。
        - `with_current` 表示当前列表不要包含 `oid` 参数值，也就是说直接拼接在上一页列表的后面，而无需在新页的列表开头重复上一页的最后一个项目。
3. 帮助中心
    1. 支持解析的链接格式以及链接的获取方式。
    2. 如何选择视频和音频格式，常见的无法播放问题排查。

## 设计思路

1. 对于视频合集和分 P 列表，以及视频合集中嵌入分 P 列表，都只需要获得其中的任意一个视频（一般取第一个），即可获得整个视频列表。
2. 对于番剧和影视剧，需要解析出正片和花絮，其中正片是一个视频列表，花絮包含多个视频列表。
3. 对于收藏夹，注意处理分页问题，在前端解析链接的过程中，展示分页解析进度，该解析过程，通过收藏夹 ID 和页码来获得视频列表。
4. 对于 UP 主空间地址，注意处理分页问题，展示分页进度，通过 UP 主 ID 和页码获取视频列表。
5. 视频解析结果分为两大类，一类是 BV 视频解析，一类是根据 EPID 或 SSID 解析
6. 解析结果显示区域，包含卡片列表，卡片包含列表名称和类型（收藏夹、播放列表、排行榜、正片、花絮、UP 主全部视频等，视开发情况调整）
    - 每个卡片点击后都会在模态框中展示视频列表，支持对视频进行多选，模态框底部按钮为【全选】【全不选】【关闭】【帮助】，之后更新卡片信息（已选择多少个项目）。
    - 最后卡片列表的底部展示操作按钮，包括【选中项操作】（下拉菜单，展开后显示【下载视频】【添加到收藏夹】）【全不选】【全选】【帮助】。
    - 点击【添加都收藏夹】，弹出收藏夹列表，可以多选，然后点击【确认加入】完成。
    - 点击【下载视频】后，弹出视频配置解析进度模态框，解析完成后，弹出视频配置列表，列表包含视频名称，基础属性【分辨率，帧率，（显示相符的：杜比视界、HDR、杜比全景声，Hi-Res），视频编码，音频编码等】。
    - 视频配置列表中，应该完全显示视频文件相关的信息，不允许出现任何和链接解析阶段相关的操作。
    - 视频配置列表，右侧放置一个配置按钮，点击后弹出新的弹窗，在里面选择该视频的信息，包括命名方式（提供可选变量名，以及实时预览最终文件名），开关（只下载音频、只下载视频，两个开关二选一，一开一关，点击开的那个则两个都关），视频质量选择、音频格式选择（杜比全景声、Hi-Res、普通格式，或其他格式看情况）。
    - 可以设置存放路径，点击之后，调用 Electron 能力选择一个目录路径。
    - 确保单个视频就包含了完整的下载配置，单个视频可以独立工作。
    - 视频配置列表模态框的底部，包含按钮【全局设置】，点击后弹窗，里面可以批量修改全部的命名规则（提供首个视频的信息作为模板，也有实时预览和表达式功能），批量修改存放路径，批量设置只下载音频、只下载视频，视频质量选择（向下兼容，列表从所有项目中聚合，比如选择 4K，那么最高只 1080P 的视频。就会取小于等于 4K 的最高质量，就是 1080P）
    - 音频质量选择（向下兼容，固定列表）
        1. 杜比全景声 >> Hi-Res >> 普通格式（如果不同时存在杜比全景声和 Hi-Res，则该项隐藏）
        2. Hi-Res >> 杜比全景声 >> 普通格式（如果不同时存在杜比全景声和 Hi-Res，则该项隐藏）
        3. 杜比全景声 >> 普通格式（如果不存在杜比全景声，则该项隐藏）
        4. Hi-Res >> 普通格式（如果不存在 Hi-Res，则该项隐藏）
        5. 普通格式（任何时候都显示）
    - 设置好了视频配置后，点击按钮【开始下载】，将视频下载任务列表发送给后端，后端批量创建下载任务，下载任务全部存到 SQLite 数据库中，但是这些任务都是未开始状态，由调度程序来从任务列表中选取任务，设置为开始，然后为该任务创建一个临时文件，临时文件地址也要存入数据库，下次启动软件时，可以根据临时文件来断点续传，尽量检测出链接是否过期，如果过期，希望前端创建任务时传入数据库的信息能够支撑后端独立重新获取下载链接。当然如果获取下载链接失败或者下载链接出错，应该提示出错信息，将任务进度设置为失败，但是并不删除临时文件，前端可以点击重试按钮，这时重新获取下载链接启动下载（需要重新开始参与调度）
    - 下载完成后，前端可以直接点击视频开始播放（模态框），也可以点击在本地目录查看。
    - 下载进度查看，弹出一个新的窗口，这样就可以边解析，便查看下载进度。
    - 系统设置，也是弹出新的窗口，可以设置主题颜色（主题色通过一个全局状态值来保存，跟随状态切换主题颜色），设置界面语言（通过一个全局状态值，在渲染 UI 时根据状态值展示内容，可暂时不设置内容，但要预留该能力），设置默认视频存放目录，点击右侧按钮选择路径。
    - 系统设置，可设置默认的音频格式选择规则，默认的视频格式选择规则，默认只下载视频、只下载音频，关于项目（项目版本号，项目地址，作者信息等）